<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cube Dodge</title>
<style>
  body{margin:0;background:#77bb55;overflow:hidden;font-family:system-ui}
  canvas{display:block;margin:0 auto;background:#77bb55}
  #ui{position:absolute;top:10px;left:10px;color:#fff;font-size:18px;background:rgba(0,0,0,0.3);padding:8px 12px;border-radius:10px;}
  #restart{margin-left:10px;padding:4px 8px;font-size:14px;}
</style>
</head>
<body>
<div id="ui">Score: <span id="score">0</span> High: <span id="high">0</span> <button id="restart">Restart</button></div>
<canvas id="game"></canvas>
<script>
(() => {
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let W = canvas.width = Math.min(600, window.innerWidth*0.95);
let H = canvas.height = Math.min(600, window.innerHeight*0.95);

window.addEventListener('resize',()=>{ W=canvas.width=Math.min(600,window.innerWidth*0.95); H=canvas.height=Math.min(600,window.innerHeight*0.95); });

const scoreEl = document.getElementById('score');
const highEl = document.getElementById('high');
const restartBtn = document.getElementById('restart');

let keys = {};
document.addEventListener('keydown', e => keys[e.key.toLowerCase()]=true);
document.addEventListener('keyup', e => keys[e.key.toLowerCase()]=false);

// Player cube
const player = {x:W/2,y:H-50,size:30,vx:0,vy:0,color:'#00ccff'};

const gravity = 0.4;
const friction = 0.9;

let enemies = [];
let particles = [];
let score = 0;
let highScore = localStorage.getItem('cubeHigh')|0;
highEl.textContent = highScore;
let gameOver = false;

// touch controls
let touchActive=false,touchX=null;
canvas.addEventListener('touchstart', e=>{ touchActive=true; touchX=e.touches[0].clientX; e.preventDefault(); },{passive:false});
canvas.addEventListener('touchmove', e=>{ touchX=e.touches[0].clientX; },{passive:false});
canvas.addEventListener('touchend', e=>{ touchActive=false; touchX=null; },{passive:false});

// enemies spawn
function spawnEnemy(){
  enemies.push({
    x:Math.random()*W,
    y:-20,
    r:rand(10,25),
    vx:rand(-2,2),
    vy:rand(2,5),
    color:'#ff5555'
  });
}

// particles
function makeParticles(x,y,c,n=10){
  for(let i=0;i<n;i++){
    particles.push({x,y,vx:rand(-3,3),vy:rand(-3,0),life:rand(20,50),size:rand(2,5),color:c});
  }
}

function rand(a,b){ return Math.random()*(b-a)+a; }

function reset(){
  player.x=W/2; player.y=H-50; player.vx=0; player.vy=0;
  enemies=[]; particles=[]; score=0; gameOver=false;
}
restartBtn.onclick=reset;

// game loop
function update(){
  if(!gameOver){
    step();
  }
  render();
  requestAnimationFrame(update);
}

// step
function step(){
  // controls
  let move=0;
  if(keys['arrowleft']||keys['a']) move=-1;
  if(keys['arrowright']||keys['d']) move=1;
  if(touchActive && touchX!==null) move=(touchX<W/2?-1:1);

  player.vx+=move*0.7;
  player.vx*=friction;

  player.vy+=gravity;

  player.x+=player.vx;
  player.y+=player.vy;

  // boundaries
  if(player.x<0) player.x=0;
  if(player.x>W-player.size) player.x=W-player.size;
  if(player.y<0) player.y=0;
  if(player.y>H-player.size) { player.y=H-player.size; player.vy=0; }

  // spawn enemies
  if(Math.random()<0.03+Math.min(score/5000,0.05)) spawnEnemy();

  // enemies update
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    e.x+=e.vx;
    e.y+=e.vy;
    if(e.y>H+50||e.x<-50||e.x>W+50) enemies.splice(i,1);

    // collision with player
    const dx = (player.x+player.size/2) - e.x;
    const dy = (player.y+player.size/2) - e.y;
    const dist = Math.sqrt(dx*dx+dy*dy);
    if(dist < player.size/2 + e.r){
      makeParticles(player.x+player.size/2, player.y+player.size/2,'#ff5555',20);
      gameOver=true;
      if(score>highScore){ highScore=score; localStorage.setItem('cubeHigh',highScore); highEl.textContent=highScore; }
      break;
    }
  }

  // particles update
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.vy+=0.1;
    p.x+=p.vx; p.y+=p.vy;
    p.life--;
    if(p.life<=0) particles.splice(i,1);
  }

  score++;
  scoreEl.textContent=score;
}

// render
function render(){
  ctx.clearRect(0,0,W,H);

  // grass field
  ctx.fillStyle='#55aa33';
  ctx.fillRect(0,0,W,H);

  // enemies
  for(let e of enemies){
    ctx.beginPath();
    ctx.fillStyle=e.color;
    ctx.arc(e.x,e.y,e.r,0,Math.PI*2); ctx.fill();
  }

  // player cube
  ctx.fillStyle=player.color;
  ctx.fillRect(player.x,player.y,player.size,player.size);

  // particles
  for(let p of particles){
    ctx.fillStyle=p.color;
    ctx.fillRect(p.x,p.y,p.size,p.size);
  }

  // Game Over overlay
  if(gameOver){
    ctx.fillStyle='rgba(0,0,0,0.6)';
    ctx.fillRect(0,H/2-50,W,100);
    ctx.fillStyle='#fff';
    ctx.font='28px system-ui';
    ctx.fillText('GAME OVER',W/2-85,H/2-10);
    ctx.font='18px system-ui';
    ctx.fillText(`Score: ${score}`,W/2-35,H/2+20);
  }
}

requestAnimationFrame(update);
})();
</script>
</body>
</html>
